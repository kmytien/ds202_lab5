---
title: 'DS202: Lab 5'
author: "MyTien Kien; kmytien"
date: "4/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(ggplot2)
library(tidyr)
library(classdata)
library(lubridate)
library(dplyr)
library(maps)

accident <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/accident.csv", stringsAsFactors = FALSE)

person <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/person.csv", stringsAsFactors = FALSE)
```

## **Questions**

**1. Are there some days of the week where more accidents happen than the others (see FARS manual, use variable DAY_WEEK)?**
```{r}
q1 <- accident %>%
      group_by(DAY_WEEK) %>%
      summarise(Accidents = n()) %>%
      mutate(DAY_WEEK = as.factor(DAY_WEEK))

ggplot(q1, aes(x = DAY_WEEK, y = Accidents)) + geom_bar(stat = 'identity') + 
      scale_x_discrete(labels = c('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday')) +
      ggtitle("Day v.s. Total Accidents") + xlab("Day of the Week") + ylab("Number of Accidents")
```

Say something here


**2. Create a data frame containing the persons who are fatally hurt in the accidents (look up variable INJ_SEV)**
```{r}
#only fatal injury or fatal injury and more?
q2 <- person %>% filter(INJ_SEV == 4)
head(q2)
```

Say something here


**3. Create a data frame containing the most dangerous vehicle make in each state. The number of persons fatally hit in the vehicle make is used to assess the (non-)safety of a make. Make sure to handle the missing values appropriately. (look up variable MAKE)**
```{r}
#need one for each state - some states have NA make
q3 <- person %>%
      filter(INJ_SEV == 4) %>%
      group_by(STATE, MAKE) %>%
      summarise(Accidents = n()) %>%
      filter(Accidents == max(Accidents))

q3 <- drop_na(q3)
q3
```

Say something here


**4.Create a map, and label each state with the most dangerous vehicle. Discuss the definition of the most dangerous vehicle, and what you find from the map. (Hint: Read the description for the STATE and COUNTY columns in the FARS manual. The state & county codes are Geographic Locator Codes (GLCs) from the General Services Administrationâ€™s (GSA) publication. Use readxl::read_xlsx to read in the GLCs.)**
```{r message=FALSE}
#Reading data
usa <- readxl::read_xlsx("FRPP_GLC_-_United_StATESaPRIL62021.xlsx")
states <- map_data('state')

#Cleaning data
usa <- usa %>% mutate(`State Code` = as.numeric(`State Code`)) %>%
         mutate(`State Name` = tolower(`State Name`))

#Finding dangerous vehicles per state
usa2 <- usa %>% left_join(q3, by = c("State Code" = "STATE")) %>%
         select(`State Name`, `State Code`, MAKE, Accidents) %>%
         mutate(MAKE = as.factor(MAKE)) %>%
         unique()

states2 <- states %>%
      left_join(usa2 %>% select("MAKE", "State Name"), by = c("region" = "State Name"))

#Creating the map
usa3 <- states2 %>% group_by(region, MAKE) %>% 
         summarize(long = mean(long), lat = mean(lat))

usa3$MAKE <- factor(usa3$MAKE, levels = c(12, 20, 37, 49), labels = c("Ford", "Chevrolet", "Honda", "Toyota"))

q4_map <- states %>% group_by(region)
q4_map %>% ggplot(aes(x = long, y = lat)) + 
         geom_polygon(aes(group = group)) +
         geom_text(aes(label = MAKE), color = 'white', size = 3, data = usa3)
```

Say something here


**5. Join the accident and person table (work out which variable(s) to use)**
```{r}
acc_person <- accident %>% left_join(person, by = c("STATE", "COUNTY", "DAY", "MONTH", "HOUR", "MINUTE"))
```

Say something here


**6. Tally the number of accidents by day of the week (DAY_WEEK), hour of the day (HOUR) and gender (SEX). Visualize the results and explain what you find.**
```{r}
q6 <- acc_person %>%
         filter(SEX < 3 & HOUR < 24 & DAY_WEEK <= 7) %>%
         group_by(DAY_WEEK, HOUR, SEX) %>%
         summarise(Accidents = n())

q6$DAY_WEEK <- factor(q6$DAY_WEEK, labels = c("Sun"," Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
q6$SEX <- factor(q6$SEX, labels = c("Male", "Female"))
                 
q6 %>% ggplot(aes(x = HOUR, y = Accidents, fill = SEX)) + geom_bar(stat = 'identity') + facet_grid(~DAY_WEEK) +
         ggtitle("Accidents by Hour/Week v.s. Sex") + xlab("Hour of Day") + ylab("Number of Accidents")
```

Say something here


**7. Now plot a choropleth map of the number of deaths on a county level. Also explain what you find.**
```{r}
counties <- map_data('county')
usa <- usa %>% mutate(`County Code` = as.numeric(`County Code`)) %>%
         mutate(`County Name` = tolower(`County Name`))

deaths <- acc_person %>%
         group_by(COUNTY) %>%
         summarise(Deaths = n())

deaths <- deaths %>%
         left_join(usa, by = c("COUNTY" = "County Code")) %>%
         select(COUNTY, Deaths, `County Name`) %>%
         unique()

deaths <- deaths %>%
         left_join(counties, by = c("County Name" = "subregion")) %>%
         select(-order)
         
deaths %>% ggplot(aes(x = long, y = lat, fill = Deaths)) +
         geom_polygon(aes(group = group))
```

Say something here


**8. Is summer or winter more dangerous? Does this depend on states? Explore and explain.**
```{r}

```

Say something here

